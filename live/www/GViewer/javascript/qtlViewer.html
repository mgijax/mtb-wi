<html>
  <link href="stain.css" rel="stylesheet" type="text/css"/>
  <link rel="stylesheet" type="text/css" href="fileUpload.css"/>
  <style type="text/css">
    .upload-icon {
      background: url('../shared/icons/fam/image_add.png') no-repeat 0 0 !important;
    }
    #fi-button-msg {
      border: 2px solid #ccc;
      padding: 5px 10px;
      background: #eee;
      margin: 5px;
      float: left;
    }
  </style>
  <head>
    <title>MTB QTL Viewer</title>
    <link rel="stylesheet" type="text/css" href="../../resources/css/ext-all.css" />
    <script type="text/javascript" src="../../adapter/ext/ext-base.js"></script>
    <script type="text/javascript" src="../../ext-all-debug.js"></script>
    <script type="text/javascript" src="PagingStore.js"></script>
    <script type="text/javascript" src="FileUploadField.js"></script>
    <script type="text/javascript" src="Karyotype-canvas.js"></script>
    <script type="text/javascript" src="FeatureGrid.js"></script>
    <script type="text/javascript" src="Legend.js"></script>
    <script type="text/javascript" src="ZoomPanel.js"></script>
    
    
  </head>
  <body>
    <script type="text/javascript">

      // number of pixels for largest chromosome
      var maxSize = 100;

      var bandingURL = 'http://narsil:8080/mtbwi/viewer.do?method=getBands';
      // used to link chromosome bands to ucsc details
      // use empty string for no link
      var UCSCBandLink='http://genome.ucsc.edu/cgi-bin/hgTracks?org=Mouse&position=';
      
      var localURL = 'http://narsil:8080/mtbwi/';
      
      var karyoPanel = null;
      var qtlStore = null;

      Ext.onReady(function() {
        
        Ext.override(Ext.form.Action.Submit,{
          features:[],
          handleResponse : function(response){
            if(this.form.errorReader){
              var rs = this.form.errorReader.read(response);
              this.features = [];
              var errors = [];
              var start = 0;
              if(qtlStore){
                start = qtlStore.getCount();
              }
              if(rs.records){
                for(var i = 0, len = rs.records.length; i < len; i++) {
                  var r = rs.records[i];
                  errors[i] = r.data;
                  var feature = new FeatureRecord({
                    chromosome:r.data.chromosome,
                    start:r.data.start,
                    end:r.data.end,
                    type:r.data.type,
                    name:r.data.name,
                    link:r.data.link,
                    label:r.data.label,
                    color:r.data.color,
                    mgiid:r.data.mgiid,
                    group:r.data.group,
                    track:r.data.track
                  });     
                  feature.id ='feature'+(start+i);
                  this.features.push(feature);
                }
              }
              
              if(errors.length < 1){
                errors = null;
              }
              return {
                success : rs.success,
                errors : errors
              };
            }
            return Ext.decode(response.responseText);
          }});
        
        FeatureRecord = Ext.data.Record.create([
          {name:'chromosome'},
          {name:'start'},
          {name:'end'},
          {name:'type'},
          {name:'color'},
          {name:'label'},
          {name:'link'},
          {name:'mgiid'},
          {name:'name'},
          {name:'group'},
          {name:'track'}
        ]);

        var fp = new Ext.FormPanel({
          id:'fp',
          fileUpload: true,
          width: 500,
          frame: true,
          autoHeight: true,
          bodyStyle: 'padding: 10px 10px 0px 10px;',
          labelWidth: 70,
          defaults: {
            anchor: '95%',
            msgTarget: 'side'
          },
          items: [{
              xtype: 'fileuploadfield',
              id: 'form-file',
              fieldLabel: 'File Path',
              name: 'filePath',
              buttonText: '',
              buttonCfg: {
                iconCls: 'upload-icon'
              }
            },
            { xtype:'textfield',
              id:'group',
              fieldLabel:'Group',
              name:'group'
            },
            { xtype:'combo',
              name:'color',
              fieldLabel:'Color',
              store: new Ext.data.ArrayStore({
                id: 0,
                fields: ['color'],
                data: [ 
                  ['aqua']
                  ,['black']
                  ,['blue']
                  ,['fuchsia']
                  ,['grey']
                  ,['green']
                  ,['lime']
                  ,['maroon']
                  ,['navy']
                  ,['olive']
                  ,['purple']
                  ,['red']
                  ,['silver']
                  ,['teal']
                  ,['white']
                  ,['yellow']
                ]
              }),
              valueField: 'color',
              displayField: 'color',
              mode:'local',
              triggerAction:'all'
            },
            { anchor:'40%',
              xtype: 'radiogroup',
              fieldLabel: 'Track',
              items: [
                {boxLabel: 'Left', name: 'track', inputValue: 'L'},
                {boxLabel: 'Right', name: 'track', inputValue: 'R', checked: true}
              ]},
            { xtype:'numberfield',
              anchor:'25%',
              emptyText: '1',
              id:'trackIndex',
              fieldLabel:'Track Index',
              name:'trackIndex',
              minValue:1
            }
          ],
          buttons: [{
              text: 'Upload',
              handler: function(){
                if(fp.getForm().isValid()){
                  fp.getForm().errorReader 
                    = new Ext.data.XmlReader({record : 'feature',
                    success: '@success'
                  }, FeatureRecord),
                  fp.getForm().submit({
                    url: 'viewer.do?method=upload',
                    waitMsg: 'Uploading data',
                    success: function(form, action){
                      loadUploadedFeatures(action.features);
                    },
                    failure: function(form, action){
                      Ext.Msg.alert('Upload Failded', 'Unable to create features from file');
                    }
                  });
                  fileWin.hide();
                }
              }
            },{
              text: 'Reset',
              handler: function(){
                fp.getForm().reset();
              }
            }]
        });
        
        function loadUploadedFeatures(records){
          qtlStore.suspendEvents();
          var start = 0;
          if(qtlStore){
            start = qtlStore.getCount();
          }
         
          qtlStore.add(records);
          qtlStore.resumeEvents();
          qtlStore.fireEvent('add',qtlStore,records,start);
          featureGrid.addAllFeatures();
        };
        
          function loadFromMGI(){
          
          var ch = zoomPanel.chromosome;
          var start = zoomPanel.start;
          var end = zoomPanel.end;
          
          if(end > 0){
        
            mgdForm.getForm().findField('chromosome').setValue(ch);
            mgdForm.getForm().findField('start').setValue(start);
            mgdForm.getForm().findField('end').setValue(end);
          }   
          mgdWin.show();
          
        };
        
         var mgdForm = new Ext.FormPanel({
          frame: true,
          bodyStyle: 'padding: 5px 5px 0px 5px;',
          defaults: {
            anchor: '95%',
            msgTarget: 'side'
          },
          autoHeight: true,
          labelWidth: 60,
          items: [
            { xtype:'textfield',
              fieldLabel:'Chr',
              name:'chromosome',
              width:165
            },
            { xtype:'numberfield',
              fieldLabel:'Start',
              name:'start',
              minValue:0,
              width:165
            },
            { xtype:'numberfield',
              fieldLabel:'End',
              name:'end',
              minValue:0,
              width:165
            },{ 
              xtype:'textarea',
              name:'pheno',
              fieldLabel:'Phenotype',
              width:165,
              height:60
            },
            { xtype:'combo',
              name:'goOp',
              fieldLabel:'Gene',
              labelSeparator:'',
              store: new Ext.data.ArrayStore({
                fields: ['comparison'],
                data: [ 
                  ['begins']
                  ,['equals']
                  ,['ends']
                  ,['contains']
                  ,['like']
                ]
              }),
              autoSelect:true,
              valueField: 'comparison',
              displayField: 'comparison',
              editable:false,
              mode:'local',
              triggerAction:'all'
            },{ 
              xtype:'textarea',
              name:'goTerm',
              fieldLabel:'Ontology',
              labelSeparator:'',
              width:165,
              height:30
            }, {
              xtype: 'checkboxgroup',
              name:'ontologyKeys',
              // Put all controls in a single column with width 100%
              columns: 1,
              items: [
                {boxLabel: 'Molecular Function', name: 'Molecular+Function', checked: true},
                {boxLabel: 'Biological Process', name: 'Biological+Process', checked: true},
                {boxLabel: 'Cellular Component', name: 'Cellular+Component', checked: true}
              ]
            }
          ],
          buttonAlign:'center',
          buttons: [{
              text: 'Query MGD',
              handler:mgdQueryHandler
       
            }]
        });
        
        
        function mgdQueryHandler(){
        
          mgdWin.hide();
          var ch = mgdForm.getForm().findField('chromosome').getValue();
          var start = mgdForm.getForm().findField('start').getValue();
          var end = mgdForm.getForm().findField('end').getValue();
          var pheno = mgdForm.getForm().findField('pheno').getValue();
    
          var chk = mgdForm.getForm().findField("ontologyKeys").getValue();  
          var ontologyKeys = ""
          for(var i = 0; i < chk.length; i++){
            ontologyKeys = ontologyKeys + ('&ontology_key='+chk[i].getName());
          }
          
          var goOp = mgdForm.getForm().findField('goOp').getValue();
          var goTerm = mgdForm.getForm().findField('goTerm').getValue();
    
          qtlStore.proxy.setUrl(localURL+'viewer.do?method=getMGIFeatures&chromosome='+ch+'&start='+start+'&end='+end
            +'&phenotype='+pheno+'&go_op='+goOp+'&go_term='+goTerm+''+ontologyKeys+"&linkTo=details");
          
          qtlStore.load({add:true});
          
          mgdForm.getForm().reset();
        };
        
        function showRegionWin(){
          var ch = zoomPanel.chromosome;
          var start = zoomPanel.start;
          var end = zoomPanel.end;
          
           createRegionForm.getForm().findField('chromosome').setValue(ch);
           createRegionForm.getForm().findField('start').setValue(start);
           createRegionForm.getForm().findField('end').setValue(end);
          
          regionWin.show();
        }
        
        function createRegion(){
          
          regionWin.hide();
          
          var ch = zoomPanel.chromosome;
          var start = zoomPanel.start;
          var end = zoomPanel.end;
          
          var name = createRegionForm.getForm().findField('name').getValue();
          var label = createRegionForm.getForm().findField('label').getValue();
          
          
          if(end > 0){
             var rec = new FeatureRecord({
              chromosome:ch,
              start:start,
              end:end,
              type:'user created',
              color:'blue',
              label:label,
              link:'gViewer.do?location='+ch+':'+start+'..'+end+'%26label='+label+'%26qtlName='+name,
              mgiid:'',
              name:name,
              group:'user created',
              track:'L1'
            });
            
            qtlStore.add(rec);
            featureGrid.store.add(rec.copy());
          }
         }
       
        var createRegionForm = new Ext.FormPanel({
          frame: true,
          bodyStyle: 'padding: 5px 5px 0px 5px;',
          defaults: {
            anchor: '95%',
            msgTarget: 'side'
          },
          autoHeight: true,
          labelWidth: 60,
          items: [
            { xtype:'textfield',
              fieldLabel:'Chr',
              name:'chromosome',
              width:165
            },
            { xtype:'numberfield',
              fieldLabel:'Start',
              name:'start',
              minValue:0,
              width:165
            },
            { xtype:'numberfield',
              fieldLabel:'End',
              name:'end',
              minValue:0,
              width:165
            },{ 
              xtype:'textfield',
              name:'name',
              fieldLabel:'Name',
              width:165
            },
            { 
              xtype:'textfield',
              name:'label',
              fieldLabel:'Label',
              labelSeparator:'',
              width:165
            }
          ],
          buttonAlign:'center',
          buttons: [{
              text: 'Create region',
              handler:createRegion
       
            }]
        });
        
         var mgdWin =  new Ext.Window({
          layout:'fit',
          target: Ext.getBody(),
          closeAction:'hide', 
          width:260,
          title: 'MGD Query',
          items:[mgdForm]
        });
        
        var regionWin =  new Ext.Window({
          layout:'fit',
          target: Ext.getBody(),
          closeAction:'hide', 
          width:260,
          title: 'Create region',
          items:[createRegionForm]
        });
    
       var fileWin = new Ext.Window({
            title:'Load features from file.',
            layout:'fit',
            width:550,
            height:215,
            closeAction:'hide', 
            items:[fp]
          });
    
        function showFPWindow(){
          fileWin.show();
          fp.getForm().reset();
        };
        
        karyoPanel = new org.jax.mgi.kmap.KaryoPanel({bandingFile:bandingURL,
          title:'<center>MTB QTL Viewer</center>',
          id:'kPanel',
          maxKaryoSize:maxSize,
          bandLink:UCSCBandLink,
          localLink:localURL,
          legend:'legendPanel',
          allowZoom:true,
          chromosomeWidth:11,
          featureGap:2,
          fCanvasHeight:250,
          fCanvasWidth:20,
          bandMaskDiv:'mainDiv',
          width:1000
        });
        
        qtlStore = new Ext.ux.data.PagingXmlStore({
          autoDestroy: true,
          storeId: 'qtlStore',
          url:'toConfigureProxy',
          record: 'feature', 
          autoLoad: false,
          autoSave:false,
          // the writer is needed to export features. maybe rewrite export
          writer: new Ext.data.XmlWriter({writeAllFields:true}),
          fields: [
            'chromosome',
            'start',
            'end',
            'type',
            'color',
            'label',
            'link',
            'mgiid',
            'name',
            'group',
            'track'
          ]	
        });	
      
        var oGridHandler = function (b,e){
          var i;
          var link = localURL+'viewer.do?method=getQTLs&';
          var selections = Ext.getCmp('oGrid').getSelectionModel().getSelections();
          for(i = 0 ; i < selections.length; i++){
            link = link+'selectedQTLTypes='+ selections[i].get("name").replace(/ /g,'+')+'&';
          }   
          Ext.getCmp('oGridMenu').hide();
          Ext.getCmp('oGridMenu').findParentByType('menu').hide();
      
          if(b.getText() == 'View'){
            
            qtlStore.proxy.setUrl(link);
        
            var mask =  new Ext.LoadMask('mainDiv', {msg:"Loading data...", removeMask:true, store:qtlStore});
            
            qtlStore.load({add:true});

          }else{
            if(b.getText() == 'as HTML'){
              link = link + 'qtlList=HTML';

            }else if(b.getText() == 'as Text'){
              link = link + 'qtlList=tabbed';
            }
            window.open(link,'qtlList');
          } 
        };
      
        var oStore = new Ext.data.XmlStore({
          autoDestroy: true,
          storeId: 'oStore',
          record: 'organ', 
          autoLoad: true,
          url:localURL+'viewer.do?method=getOrganGroups',
          fields: [
            'name',
            'color'
          ]
        });
        
        var oGridCM =  new Ext.grid.ColumnModel({columns:[
            {id:'name', sortable: true, dataIndex: 'name'}
          ]});
        
        var oGrid = new Ext.grid.GridPanel({
          id:'oGrid',
          selModel:new Ext.grid.RowSelectionModel(),
          store:oStore,
          cm:oGridCM,
          stripeRows: true,
          height:200,
          width:200,
          viewConfig:{autoFill:true},
          autoExpandColumn:'name',
          bbar: [ {text: 'View',
              handler:oGridHandler,
              scope:this
            },'-',
            {text: 'as HTML',
              handler:oGridHandler,
              scope:this
            },'-',
            {text: 'as Text',
              handler:oGridHandler,
              scope:this
            }
          ]
        });
     
        var oGridMenu = new Ext.menu.Menu({
          id: 'oGridMenu',
          style: {
            overflow: 'visible'     
          },
          items: [oGrid]
        });
        
        karyoPanel.setFeatureStore(qtlStore);
        
        karyoPanel.getTopToolbar().add('-');
        
        karyoPanel.getTopToolbar().add(
        {text:'Help',
          menu:{items:[{text:'Viewer Help', handler:helpHandler}
            ]}});
        
        karyoPanel.getTopToolbar().add('-');
        
        karyoPanel.getTopToolbar().addButton({
          text:'Load annotations from MGD',
          handler:loadFromMGI
        });
        
         karyoPanel.getTopToolbar().add('-');
        
        karyoPanel.getTopToolbar().addButton({
          text:'Create region',
          handler:showRegionWin
        });
        
        karyoPanel.getTopToolbar().add('-');
      
        karyoPanel.getTopToolbar().items.items[0].menu.add({
          text:'Display QTLs',
          menu:oGridMenu
        });
        
        karyoPanel.getTopToolbar().items.items[0].menu.add({
          text:'Load Features',
          handler:showFPWindow
        });
        
        karyoPanel.getTopToolbar().items.items[0].menu.add(
        {text:'Export',
          handler:karyoPanel.exportFeatures,
          scope:karyoPanel
        });
      
        var zoomPanel = new org.jax.mgi.kmap.ZoomPanel({
          id:'zoomPanel',
          rowspan:2,
          minWidth:200,
          kPanel:karyoPanel});
                       
        var featureGrid = new org.jax.mgi.kmap.FeatureGrid({
          id:'featureGrid',
          rowspan:1,
          colspan:1,
          editable:false,
          hideTopToolbar:true,
          kPanel:karyoPanel,
          localLink:localURL,
          viewConfig:{autoFill:true, markDirty:false},
          tbar: new Ext.Toolbar({}),
          bbar: new Ext.PagingToolbar({      
            displayInfo: true,
            pageSize:5,
            prependButtons: true
          })
        });
      
      
        // table for the center
        var centerTable = new Ext.Panel({
          region: 'center',
          layout:'table',
          layoutConfig:{columns:2},
          items:[karyoPanel,zoomPanel,featureGrid]
         
        });

        // Legend Panel to the west
       
        var legendPanel = new org.jax.mgi.kmap.LegendPanel({
          autoScroll:true,
          title:'Legend',
          id:'legendPanel',
          region: 'west',
          split: true,
          width: 350,
          collapsible:true,
          collapsed:true,
          style:{borderstyle:'none'},
          karyoPanel:karyoPanel
        });

        var mainContainer = new Ext.Container({
          height:780,  // the kPanel height is based on the size of the chromosomes so this value is really how the legend panel is sized
        //  width:1200,
          layout: 'border',
          renderTo:'mainDiv',
          items: [centerTable,legendPanel],
          style:{background:'white'}
        });

        mainContainer.doLayout();
      
        zoomPanel.doLayout();
        zoomPanel.hide();
        
        karyoPanel.loadBands();
                                                        
        featureGrid.doLayout();
      
        zoomPanel.on('featureClick',featureGrid.selectFeature,featureGrid);
        zoomPanel.on('featureRightClick',karyoPanel.featureRightClick,karyoPanel);
        zoomPanel.on('featureMouseOver',karyoPanel.featureMouseOver,karyoPanel);
        zoomPanel.on('featureMouseOut',karyoPanel.featureMouseOut,karyoPanel);
        
        
        var helpWindow = null;
        
        function helpHandler(){
          if(!helpWindow){
            helpWindow = new Ext.Window({
              title:'MTB QTL Viewer Help',
              layout:'fit',
              width:550,
              height:300,
              closeAction:'hide',
              plain: true,
              html:"QTLs are loaded into the viewer from the 'File' menu.<br>"+
                "From the 'File' menu select 'Display QTLs' to see a list of organ groups.<br>"+
                "Select one or more organ groups and click 'View' to load QTLs from those groups.<br>"+
                "From the same menu QTL data can also be viewed as HTML or plain text.<br>"+
                "The legend panel shows the color coding of each loaded QTL group. It can be minimized or resized.<br>"+
                "<br>From the 'View' menu, individual chromosomes can be hidden or displayed.<br>"+
                "Axes can be added to indicate megabase pair positions along the chromosomes.<br>"+
                "<br>To zoom in on a region click on the chromosome and select a magnification.<br>"+
                "The zoom panel has buttons to scroll along the chromosome.<br>"+
                "The gear button automates the scrolling.<br>"+
                "<br>Click on a QTL to highlight it in the grid.<br>"+
                "Double click on a row in the grid to flash the corresponding QTL.<br>"+
                "Right-click on a chromosome to link to the cytoband region in the UCSC browser.<br>"+
                "Right-click on a QTL or click its symbol in the grid for more details and to search for genes in that region.<br>"+
                "<br>The viewer uses Javascript, and popups which should be enabled on your browser.<br>"+
                "For optimum results use a browser other than Internet Explorer."
            });
          }
          helpWindow.show(); 
        };
       // allows the form to be run outside of mtbwi app
       document.forms['exportForm'].action = localURL+'viewer.do?method=export';
        
        
      });  //end onReady()
    </script>
    <noscript><h2 align="center">The QTL Viewer requires Javascript which is disabled or unavailable on your browser.</h2></noscript>
    
    <div id="mainDiv"></div>
    
    <form action="" id="exportForm" target="_blank" method="post" >
      <input type="hidden" name="export" value="true">
      <input type="hidden" id="exportXML" name="exportXML" value="">
    </form>
    
    
  </body>
</html> 
